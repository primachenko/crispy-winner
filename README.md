## Новая установка

Установка подразумевается на linux-сервере, установка будет рассмотрена на примере Ubutnu
### Обновление репозитория и установка необходимых пакетов
```
sudo apt update
sudo apt install git docker.io docker-compose
```
### Клонирование репозитория управления
```
git clone --branch=main https://github.com/primachenko/crispy-winner.git ~/crispy-winner
cd ~/crispy-winner
```
### Вызов скрипта для генерации файла с токеном бота
```
bash bot_init.sh
```
Скрипт в интерактивном режиме будет предлагать ввести токен бота, ID чата для агентов (в него бот должен быть добавлен как администратор) техподдержки и ID чата для запросов регистрации - в нем бот должен просто иметь достаточно прав для отправки сообщений, а также URL (в формате `https://hostname:port`) и пару логин/пароль использумого QNAP, а также параметры требуемые для синхронизации пользователей из Google Tables. Файл для OAuth должен иметь имя `service-account.json`.
Результатом работы скрипта будет появление файла `bot_token.py`.
### Миграция со старой версии (опционально)
Для того чтобы сохранить содержимое каталога и пользователей из прошлой версии бота, нужно перенести файлы `catalog_storage.yml` и `users.yml` в папку `resources`
```
cp ~/tsbot/resources/catalog_storage.yml ~/crispy-winner/
cp ~/tsbot/resources/users.yml ~/crispy-winner/
```
### Установка актуальной версии бота из архива
Полученный от разработчиков архив `tsbot_latest.tar.gz` следует поместить в корень репозитория управления
```
cp ~/Downloads/tsbot_latest.tar.gz ~/crispy-winner/
```
После этого следует вызвать скрипт для установки
```
bash bot_update.sh
```
После завершения работы этой команды бот запущен и готов к работе
### Управление ботом
Для управления ботом, в репозитории управления есть 3 скрипта
`bot_start.sh` - для запуска бота
`bot_stop.sh` - для остановки бота
`bot_restart.sh` - для перезапуска бота
### Получения обновлений
Для применения последующих обновлений следует провести процедуру аналогичную установке - полученный от разработчиков архив  `tsbot_latest.tar.gz` следует поместить в корень репозитория и вызвать скрипт
```
bash bot_update.sh
```
### Откат обновления
На случай если обновление приводит к критическим проблемам, препятствующим использованию бота, предусмотрен скрипт для возвращения на прошлую версию
```
bash bot_downgrade.sh
```
При вызове этого скрипта бот будет перезапущен на прошлой версии ПО, если это возможно.

